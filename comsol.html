<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>COMSOLè¨­å®šç®¡ç†ï¼ˆCOMSOLé¢¨ãƒ•ãƒ«ç‰ˆ / ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ—¢å®šå€¤è¾¼ã¿ï¼‰</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",Meiryo,sans-serif;background:#f3f6fb;color:#333}
.container{display:flex;height:100vh}
.sidebar{width:340px;background:#fff;border-right:1px solid #dfe3ea;overflow-y:auto;box-shadow:2px 0 5px rgba(0,0,0,.05)}
.header{background:#1f4e79;color:#fff;padding:16px 18px;font-size:16px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
.header-actions{display:flex;gap:8px}
.header-btn{background:#2c5aa0;border:1px solid #4a7bb8;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;transition:background .2s}
.header-btn:hover{background:#3a6bb0}
.modelroot{padding:10px 18px;color:#1f4e79;font-weight:700;border-bottom:1px solid #eef2f7}
.category{border-bottom:1px solid #eef2f7}
.category-header{padding:12px 18px;background:#f7f9fc;cursor:pointer;display:flex;align-items:center;transition:background .15s}
.category-header:hover{background:#eef4ff}
.category-header.active{background:#e8f1ff;color:#2c5aa0}
.category-icon{width:24px;height:24px;margin-right:10px;display:flex;align-items:center;justify-content:center}
.toggle-icon{margin-left:auto;transition:transform .25s;font-size:13px}
.toggle-icon.expanded{transform:rotate(90deg)}
.subcategories{display:none;background:#fff}
.subcategories.show{display:block}
.subcategory{padding:10px 18px 10px 52px;cursor:pointer;border-left:3px solid transparent;font-size:13px}
.subcategory:hover{background:#f6f9ff}
.subcategory.active{background:#e8f1ff;border-left-color:#2c5aa0;color:#2c5aa0;font-weight:600}
.main-content{flex:1;display:flex;gap:16px;padding:16px;overflow:hidden}
.view-placeholder{flex:1;background:linear-gradient(180deg,#f8fbff,#fff);border:1px dashed #d5ddeb;border-radius:8px;min-height:200px;display:flex;align-items:center;justify-content:center;color:#8aa1c1}
.details{flex:1.4;min-width:520px;max-width:920px;overflow:auto}
.panel{background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.06);border:1px solid #e7ecf5;margin-bottom:14px}
.panel-hd{display:flex;align-items:center;gap:10px;padding:14px 16px;background:#f7f9fc;border-bottom:1px solid #e7ecf5}
.panel-title{font-weight:800;color:#2c5aa0}
.panel-bd{padding:14px 16px}
.badge{display:inline-block;padding:2px 7px;border-radius:12px;background:#eef5ff;color:#2c5aa0;font-size:11px;margin-left:6px}
.badge-warn{background:#fff1d6;color:#ad5a00}
.kv{display:grid;grid-template-columns:180px 1fr;gap:10px;margin:6px 0}
.kv label{font-size:12px;color:#667}
.kv input,.kv select{border:1px solid #d9e0ea;border-radius:6px;padding:8px;font-size:13px}
.section{margin:8px 0 12px}
.section-title{font-weight:800;color:#1f4e79;margin:10px 0 6px}
.small{font-size:12px;color:#8795a8}
.hr{height:1px;background:#eef2f7;margin:10px 0}

.table-wrap{border:1px solid #e4e9f2;border-radius:8px;overflow:hidden;margin:8px 0;background:#fff}
.table-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f7f9fc;border-bottom:1px solid #e4e9f2}
.table-title{font-weight:700;color:#2c5aa0}
.table-actions button{border:1px solid #2c5aa0;background:#2c5aa0;color:#fff;font-size:12px;padding:6px 10px;border-radius:6px;cursor:pointer;margin-left:4px}
.table-actions button:hover{background:#3a6bb0}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #eef2f7;padding:8px 10px;font-size:13px;vertical-align:top}
.table th{background:#fafcff;text-align:left;color:#556}
.table td input,.table td textarea,.table td select{width:100%;padding:6px;border:1px solid #d9e0ea;border-radius:6px;font-size:13px;font-family:Consolas,Monaco,monospace}
.table td textarea{min-height:44px;resize:vertical}
.row-del{cursor:pointer;border:none;background:transparent;font-size:18px;line-height:1;color:#b00020}
.row-del:hover{color:#d32f2f}
.switch{position:relative;display:inline-block;width:38px;height:22px}
.switch input{display:none}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#cdd7e6;transition:.2s;border-radius:22px}
.slider:before{position:absolute;content:"";height:18px;width:18px;left:2px;bottom:2px;background:white;transition:.2s;border-radius:50%}
input:checked + .slider{background:#2c5aa0}
input:checked + .slider:before{transform:translateX(16px)}

.chips{display:flex;gap:6px;flex-wrap:wrap;border:1px solid #d9e0ea;border-radius:6px;padding:6px}
.chip{background:#eef5ff;color:#1f4e79;border-radius:12px;padding:3px 8px;font-size:12px}
.chips input{border:none;outline:none;min-width:120px}

.stats{background:#fff;padding:12px 16px;border-top:1px solid #dfe3ea;position:sticky;bottom:0}
.stat-row{display:flex;justify-content:space-between;font-size:12px}
.progress-bar{position:fixed;bottom:0;left:0;right:0;height:4px;background:#e0e6ef;z-index:1000}
.progress-fill{height:100%;background:linear-gradient(90deg,#1f4e79,#4caf50);transition:width .25s;width:0%}

.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:2000;align-items:center;justify-content:center}
.modal.show{display:flex}
.modal-content{background:#fff;border-radius:12px;padding:24px;max-width:500px;width:90%;box-shadow:0 8px 24px rgba(0,0,0,.2)}
.modal-title{font-size:18px;font-weight:700;color:#1f4e79;margin-bottom:16px}
.modal-actions{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}
.btn{padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;border:none}
.btn-primary{background:#2c5aa0;color:#fff}
.btn-primary:hover{background:#3a6bb0}
.btn-secondary{background:#e0e6ef;color:#333}
.btn-secondary:hover{background:#d0d8e5}

.toast{position:fixed;top:20px;right:20px;background:#2c5aa0;color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:3000;display:none;animation:slideIn .3s ease}
.toast.show{display:block}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}

.imp-row td{background:#fff7e6}
.imp-badge{display:inline-block;margin-left:8px;padding:1px 6px;border-radius:10px;background:#ffebc2;color:#8a4b00;font-size:11px;border:1px solid #f3c98b}

@media print{
  .sidebar,.header-actions,.progress-bar,.table-actions button,.row-del{display:none!important}
  .container{display:block;height:auto}
  .main-content{padding:0;display:block}
  .details{max-width:100%;min-width:100%}
  .panel{page-break-inside:avoid;box-shadow:none;border:1px solid #ccc}
  body{background:#fff}
}
</style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <div class="header">
      <span>Model Builder</span>
      <div class="header-actions">
        <button class="header-btn" onclick="exportJSON()" title="JSONã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">ğŸ’¾</button>
        <button class="header-btn" onclick="importJSON()" title="JSONã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ">ğŸ“‚</button>
        <button class="header-btn" onclick="exportPDF()" title="PDFã§å‡ºåŠ›">ğŸ“„</button>
      </div>
    </div>
    <div class="modelroot">ãƒ¢ãƒ‡ãƒ«ï¼ˆModel 1ï¼‰</div>

    <div class="category">
      <div class="category-header" onclick="toggleCategory(this)">
        <div class="category-icon">ğŸ“Š</div><span>ã‚°ãƒ­ãƒ¼ãƒãƒ«å®šç¾©ï¼ˆGlobal Definitionsï¼‰</span><span class="toggle-icon">â–¶</span>
      </div>
      <div class="subcategories">
        <div class="subcategory" onclick="showContent('parameters')">Parameters</div>
        <div class="subcategory" onclick="showContent('variables')">Variables</div>
        <div class="subcategory" onclick="showContent('functions')">Functions</div>
      </div>
    </div>

    <div class="category">
      <div class="category-header" onclick="toggleCategory(this)">
        <div class="category-icon">ğŸ§©</div><span>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ 1ï¼ˆcomp1ï¼‰</span><span class="toggle-icon">â–¶</span>
      </div>
      <div class="subcategories">
        <div class="subcategory" onclick="showContent('geometry')">Geometry</div>
        <div class="subcategory" onclick="showContent('materials')">Materials</div>
        <div class="subcategory" onclick="showContent('physics')">Physics</div>
        <div class="subcategory" onclick="showContent('mesh')">Mesh</div>
      </div>
    </div>

    <div class="category">
      <div class="category-header" onclick="toggleCategory(this)">
        <div class="category-icon">ğŸ“ˆ</div><span>ã‚¹ã‚¿ãƒ‡ã‚£ï¼ˆStudyï¼‰</span><span class="toggle-icon">â–¶</span>
      </div>
      <div class="subcategories">
        <div class="subcategory" onclick="showContent('study')">Study 1</div>
        <div class="subcategory" onclick="showContent('solver')">Solver / Convergence</div>
      </div>
    </div>

    <div class="category">
      <div class="category-header" onclick="toggleCategory(this)">
        <div class="category-icon">ğŸ§ª</div><span>çµæœï¼ˆResultsï¼‰</span><span class="toggle-icon">â–¶</span>
      </div>
      <div class="subcategories">
        <div class="subcategory" onclick="showContent('results')">Datasets / Plot Groups</div>
        <div class="subcategory" onclick="showContent('derived')">Derived Values</div>
      </div>
    </div>

    <div class="stats">
      <div class="stat-row"><span>ãƒã‚§ãƒƒã‚¯æ¸ˆã¿</span><span><span id="checked-count">0</span>/<span id="total-count">0</span></span></div>
      <div class="stat-row"><span>é€²æ—ç‡</span><span><span id="progress-percent">0</span>%</span></div>
    </div>
  </div>

  <div class="main-content">
    <div class="view-placeholder">ï¼ˆãƒ“ãƒ¥ãƒ¼é ˜åŸŸ / å‚è€ƒï¼šCOMSOLã®ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼‰</div>
    <div class="details" id="main">
      <div class="panel">
        <div class="panel-hd"><div class="panel-title">COMSOLè¨­å®šç®¡ç†ï¼ˆCOMSOLé¢¨ / æ—¢å®šå€¤è¾¼ã¿ï¼‰</div></div>
        <div class="panel-bd small">
          å·¦ã®ãƒ„ãƒªãƒ¼ã‹ã‚‰ãƒãƒ¼ãƒ‰ã‚’é¸æŠã™ã‚‹ã¨ã€å³å´ã«ã€ŒSettingsã€é¢¨ã®ç·¨é›†UIãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
          <b>ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼š</b>ãƒ˜ãƒƒãƒ€ãƒ¼ã®ğŸ’¾ãƒœã‚¿ãƒ³ã§JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ğŸ“‚ãƒœã‚¿ãƒ³ã§èª­ã¿è¾¼ã¿ã€ğŸ“„ãƒœã‚¿ãƒ³ã§PDFå‡ºåŠ›ã§ãã¾ã™ã€‚<br>
          <b>è‡ªå‹•ä¿å­˜ï¼š</b>ãƒ–ãƒ©ã‚¦ã‚¶ã«è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆåŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã‘ã°å¾©å…ƒã•ã‚Œã¾ã™ï¼‰ã€‚<br>
          <b>ï¼Šå¼·èª¿ï¼š</b>ã€Œï¼Šã€ãŒä»˜ã„ãŸé‡è¦ãƒ»çµ±ä¸€é …ç›®ã¯è¡Œã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¦ã„ã¾ã™ã€‚
        </div>
      </div>
    </div>
  </div>
</div>

<div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>

<div class="modal" id="import-modal">
  <div class="modal-content">
    <div class="modal-title">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
    <input type="file" id="file-input" accept=".json" style="width:100%;padding:10px;border:1px solid #d9e0ea;border-radius:6px">
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="loadJSONFile()">èª­ã¿è¾¼ã¿</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const nextId = {
  param:1, var:1, fn:1,
  blk:1, cyl:1, dif:1, arr:1,
  mat:1, bc:1, mesh:1,
  stp:1, dset:1, pg:1, plt:1,
  mfh:1, ec:1, ht:1
};
function newTag(prefix){ return prefix + (nextId[prefix]++); }

let checkStates = {}, inputValues = {};
function initChecks(id, items=[]){
  checkStates[id] = items.map(()=>false);
  inputValues[id] = items.map(()=> '');
}
function toggleCheck(id,i){
  checkStates[id][i]=!checkStates[id][i];
  updateStats();
}
function saveInput(id,i,v){ inputValues[id][i]=v; }
function updateStats(){
  let t=0,d=0;
  for(const k in checkStates){ t+=checkStates[k].length; d+=checkStates[k].filter(Boolean).length; }
  const p=t?Math.round(100*d/t):0;
  document.getElementById('checked-count').textContent=d;
  document.getElementById('total-count').textContent=t;
  document.getElementById('progress-percent').textContent=p;
  document.getElementById('progress-fill').style.width=p+'%';
}

function parseRanges(str){
  const out=[];
  (str||'').split(',').map(s=>s.trim()).filter(Boolean).forEach(tok=>{
    if(/^\d+\s*-\s*\d+$/.test(tok)){
      let [a,b]=tok.split('-').map(n=>+n.trim());
      for(let k=Math.min(a,b); k<=Math.max(a,b); k++) out.push(k);
    }else if(/^\d+$/.test(tok)){ out.push(+tok); }
  });
  return Array.from(new Set(out));
}
function chipsHTML(values, onChange){
  const nodes = (values||[]).map(v=>`<span class="chip">${v}</span>`).join('');
  const id = 'chips-'+Math.random().toString(36).slice(2);
  setTimeout(()=>{
    const input = document.querySelector(`#${id}`);
    if(input) input.addEventListener('change', e=>{
      onChange(parseRanges(e.target.value));
      showContent(currentId);
      autoSave();
    });
  },0);
  return `<div class="chips">${nodes}<input id="${id}" placeholder="ä¾‹ï¼š1,2,5-8"/></div>`;
}

const model = {
  global:{
    parameters:[],
    variables:[],
    functions:[]
  },
  comp1:{
    geometry:{
      features:[],
      patterns:[],      // è¿½åŠ ï¼šå½¢çŠ¶ãƒ‘ã‚¿ãƒ¼ãƒ³è¡¨
      notes:''          // è¿½åŠ ï¼šå½¢çŠ¶å¤‰æ›´ãƒ«ãƒ¼ãƒ«
    },
    materials:[],
    physics:[],
    mesh:{ features:[] }
  },
  study:{
    tag:'std1', name:'Study 1',
    steps:[],
    solver:[
      {type:'Time Dependent', lin:'Direct', nonlin:'Fully coupled', precond:'', rel:'', abs:'', maxit:'', notes:'æ™‚é–“ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ã®éç·šå½¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’æœ‰åŠ¹ / å¼·é€£æˆã‚’ç›´æ¥è§£æ³•ã§'}
    ]
  },
  results:{
    datasets:[],
    plotGroups:[],
    derived:[]
  }
};

// === æ—¢å®šå€¤ã®æŠ•å…¥ ===
function seed(){
  // Parametersï¼ˆï¼Šã¯ imp:true ã§å¼·èª¿ï¼‰
  model.global.parameters.push(
    {tag:newTag('param'),name:'gap',expr:'4',unit:'mm',desc:'ãƒãƒ«ã‚¯é–“è·é›¢'},
    {tag:newTag('param'),name:'radius_bulk',expr:'15',unit:'mm',desc:'ãƒãƒ«ã‚¯ç›´å¾„'},
    {tag:newTag('param'),name:'thickness_bulk',expr:'5',unit:'mm',desc:'ãƒãƒ«ã‚¯åšã¿'},
    {tag:newTag('param'),name:'lambda',expr:'10',unit:'mm',desc:'å‘¨æœŸé•·'},
    {tag:newTag('param'),name:'magnetization_time',expr:'1000',unit:'s',desc:'ç£åŒ–æ™‚é–“'},
    {tag:newTag('param'),name:'relaxation_time',expr:'1000',unit:'s',desc:'ç·©å’Œæ™‚é–“'},
    {tag:newTag('param'),name:'Dy2',expr:'1',unit:'mm',desc:'ãƒªãƒ³ã‚°ç›´ç·šéƒ¨ã®yæ–¹å‘é•·ã•',imp:true},
    {tag:newTag('param'),name:'Dz2',expr:'lambda-thickness_bulk-g_C*4',unit:'mm',desc:'ãƒªãƒ³ã‚°ç›´ç·šéƒ¨ã®zæ–¹å‘é•·ã•'},
    {tag:newTag('param'),name:'J_c_param',expr:'10',unit:'[kA/mm^2]',desc:'è‡¨ç•Œé›»æµå¯†åº¦',imp:true},
    {tag:newTag('param'),name:'Bs_time',expr:'5000',unit:'s',desc:'ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹è§£ææ™‚ã®æ™‚é–“'},
    {tag:newTag('param'),name:'Bs',expr:'5',unit:'T',desc:'å¤–éƒ¨ç£å ´',imp:true},
    {tag:newTag('param'),name:'Bs_min',expr:'-5',unit:'T',desc:'ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹è§£ææ™‚ã®æœ€å°ç£å ´'},
    {tag:newTag('param'),name:'Bs_max',expr:'5',unit:'T',desc:'ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹è§£ææ™‚ã®æœ€å¤§ç£å ´'},
    // ä¾å­˜å®šæ•°ï¼ˆå¤‰æ•°ã§ä½¿ç”¨ï¼‰
    {tag:newTag('param'),name:'mu0_const',expr:'4*pi*1e-7',unit:'[H/m]',desc:'çœŸç©ºã®é€ç£ç‡ï¼ˆå®šæ•°ï¼‰'}
  );

  // Variables
  model.global.variables.push(
    {tag:newTag('var'),name:'VECT_normJ',expr:'sqrt((mfh.Jx+eps)^2+(mfh.Jy+eps)^2+(mfh.Jz+eps)^2)',unit:'[A/m^2]',note:''},
    {tag:newTag('var'),name:'n',expr:'21',unit:'',note:'åæŸã™ã‚‹ã‚ˆã†ã«çµ±ä¸€',imp:true},
    {tag:newTag('var'),name:'E_c',expr:'0.0001',unit:'[V/m]',note:''},
    // E-J ãƒ‘ãƒ¯ãƒ¼å‰‡ã«åŸºã¥ãæŠµæŠ—ç‡ï¼ˆVECT_normJ ã‚’åˆ©ç”¨ï¼‰
    {tag:newTag('var'),name:'rho_SC',expr:'E_c*(1/VECT_normJ)*abs((VECT_normJ/J_c)^n)',unit:'',note:'è¶…ä¼å°ç›¸ã®è¦‹ã‹ã‘æŠµæŠ—ç‡'},
    {tag:newTag('var'),name:'rho_AIR',expr:'1',unit:'[Î©*m]',note:''},
    {tag:newTag('var'),name:'H_ext',expr:'int2(t)/mu0_const',unit:'',note:'æ¡ä»¶ã§é–¢æ•°åå¤‰æ›´å¯ï¼ˆint2 or int3 ç­‰ï¼‰',imp:true},
    {tag:newTag('var'),name:'J_c',expr:'J_c_param',unit:'',note:''}
  );

  // Functionsï¼ˆAnalytic + Piecewise ã«å¯¾å¿œï¼‰
  model.global.functions.push(
    // int2: 0â†’-Bs, t=magnetization_time ã§ Bs, ä»¥å¾Œ Bs ã‚’ä¿æŒ
    {tag:newTag('fn'),fname:'int2',args:'t',type:'Piecewise',unit:'',pieces:[
      {x:'0', y:'-Bs'},
      {x:'magnetization_time', y:'Bs'},
      {x:'magnetization_time+relaxation_time', y:'Bs'}
    ]},
    // int3: ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹å¾€å¾©ãƒ‘ã‚¿ãƒ¼ãƒ³
    {tag:newTag('fn'),fname:'int3',args:'t',type:'Piecewise',unit:'',pieces:[
      {x:'0',    y:'(Bs_min+Bs_max)/2'},
      {x:'1000', y:'Bs_max'},
      {x:'2000', y:'(Bs_min+Bs_max)/2'},
      {x:'3000', y:'Bs_min'},
      {x:'4000', y:'(Bs_min+Bs_max)/2'},
      {x:'5000', y:'Bs_max'}
    ]}
  );

  // Geometryï¼šåŸºæœ¬å½¢çŠ¶ã¯çœç•¥ã—ã€ãƒ‘ã‚¿ãƒ¼ãƒ³è¡¨ã¨å¤‰æ›´ãƒ«ãƒ¼ãƒ«ã‚’æ ¼ç´
  model.comp1.geometry.patterns.push(
    {tag:newTag('blk'), name:'å½¢çŠ¶ãƒ‘ã‚¿ãƒ¼ãƒ³ 1', cols:['ãƒªãƒ³ã‚°æ•°=2','å‘¨æœŸ=1','ã‚«ãƒƒãƒˆ=Ã—','è§£æ=Jc,Dy2,Bs']},
    {tag:newTag('blk'), name:'å½¢çŠ¶ãƒ‘ã‚¿ãƒ¼ãƒ³ 2', cols:['ãƒªãƒ³ã‚°æ•°=2','å‘¨æœŸ=1','ã‚«ãƒƒãƒˆ=â—‹','è§£æ=â€”']},
    {tag:newTag('blk'), name:'å½¢çŠ¶ãƒ‘ã‚¿ãƒ¼ãƒ³ 3', cols:['ãƒªãƒ³ã‚°æ•°=2','å‘¨æœŸ=0.5','ã‚«ãƒƒãƒˆ=Ã—','è§£æ=â€”']},
    {tag:newTag('blk'), name:'å½¢çŠ¶ãƒ‘ã‚¿ãƒ¼ãƒ³ 4', cols:['ãƒªãƒ³ã‚°æ•°=2','å‘¨æœŸ=0.5','ã‚«ãƒƒãƒˆ=â—‹','è§£æ=â€”']},
    {tag:newTag('blk'), name:'å½¢çŠ¶ãƒ‘ã‚¿ãƒ¼ãƒ³ 5', cols:['ãƒªãƒ³ã‚°æ•°=1','å‘¨æœŸ=1','ã‚«ãƒƒãƒˆ=Ã—','è§£æ=â€”']},
    {tag:newTag('blk'), name:'å½¢çŠ¶ãƒ‘ã‚¿ãƒ¼ãƒ³ 6', cols:['ãƒªãƒ³ã‚°æ•°=1','å‘¨æœŸ=1','ã‚«ãƒƒãƒˆ=â—‹','è§£æ=â€”']}
  );
  model.comp1.geometry.notes =
    'ã€ã‚«ãƒƒãƒˆ=â—‹ã€‘ãƒãƒªã‚´ãƒ³2ç¨®ã®ã€Œ3.7ç‚¹ã€ã® y åº§æ¨™ã‚’å¤‰æ›´ã€‚\\n' +
    'ã€å‘¨æœŸ=0.5ã€‘ç·šåˆ†é•· = lambda/2, ãƒã‚¤ãƒ³ãƒˆæ•°=1, åº§æ¨™: (0,0,0)ã€‚\\n' +
    'ã€å‘¨æœŸ=1ã€‘  ç·šåˆ†é•· = lambda, ãƒã‚¤ãƒ³ãƒˆæ•°=2, åº§æ¨™: (0,0,lambda/4), (0,0,-lambda/4)ã€‚\\n' +
    'â€» è§£æãƒ‘ã‚¿ãƒ¼ãƒ³ã¯1è¡Œç›®ã®æŒ‡å®šï¼ˆJc, Dy2, Bsï¼‰ã¨åŒä¸€ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ã€‚';

  // Materialsï¼ˆé¸æŠç•ªå·ã¯æœªæŒ‡å®šã®ãŸã‚ãƒãƒ¼ãƒˆã§æ˜ç¤ºï¼‰
  model.comp1.materials.push(
    {tag:newTag('mat'),name:'AIR',active:true,selection:[],props:[{prop:'rho',val:'1.2',unit:'kg/m^3'}], note:'ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼šå…¨éƒ¨'},
    {tag:newTag('mat'),name:'SC1',active:true,selection:[],props:[], note:'ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼šãƒãƒ«ã‚¯'},
    {tag:newTag('mat'),name:'SC2',active:true,selection:[],props:[], note:'ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼šãƒªãƒ³ã‚°'}
  );

  // Physicsï¼ˆé ˜åŸŸã¯ãƒãƒ¼ãƒˆã§æ˜ç¤ºï¼‰
  model.comp1.physics.push(
    {tag:'mfh'+(nextId.mfh++),name:'AIR',type:'mfh',active:true,selection:[],params:[], note:'è¡¨é¢'},
    {tag:'ec'+(nextId.ec++),name:'M_insu',type:'ec',active:true,selection:[],params:[], note:'æ–­é¢éƒ¨åˆ†'},
    {tag:'ht'+(nextId.ht++),name:'initial',type:'ht',active:true,selection:[],params:[], note:'å…¨éƒ¨'},
    {tag:'mfh'+(nextId.mfh++),name:'SC',type:'mfh',active:true,selection:[],params:[], note:'ãƒãƒ«ã‚¯, ãƒªãƒ³ã‚°'},
    {tag:'mfh'+(nextId.mfh++),name:'M_field',type:'mfh',active:true,selection:[],params:[], note:'æ–­é¢ã§ãªã„éƒ¨åˆ†'}
  );

  // Meshï¼ˆåç§°ã«åˆã‚ã›ã¦ Size / Mapped / Swept ã‚’è¨­å®šï¼‰
  model.comp1.mesh.features.push(
    {tag:newTag('mesh'),name:'Beam â€“ Mapped',type:'Mapped',active:true,selection:[],params:[
      {k:'æ¨ªåˆ†å‰²',v:'1',note:''},{k:'ç¸¦åˆ†å‰²',v:'2',note:''}
    ]},
    {tag:newTag('mesh'),name:'Beam â€“ Swept',type:'Swept',active:true,selection:[],params:[
      {k:'å±¤æ•°',v:'50',note:''}
    ]},
    {tag:newTag('mesh'),name:'Bulk â€“ Size',type:'Size',active:true,selection:[],params:[
      {k:'è¦ç´ ã‚µã‚¤ã‚º',v:'0.001[m]',note:'SC'}
    ]},
    {tag:newTag('mesh'),name:'Ring â€“ Size',type:'Size',active:true,selection:[],params:[
      {k:'è¦ç´ ã‚µã‚¤ã‚º',v:'0.001[m]',note:'SC1'}
    ]},
    {tag:newTag('mesh'),name:'Air â€“ Size',type:'Size',active:true,selection:[],params:[
      {k:'è¦ç´ è¨­å®š',v:'æ®‹ã‚Šã®é ˜åŸŸ',note:'AIR'}
    ]}
  );

  // Studyï¼ˆJc, Dy2 ã¯ Parametric Sweep + Time Dependentã€Bs ã¯ Time Dependentï¼‰
  // Jc
  model.study.steps.push(
    {tag:newTag('stp'),type:'Parametric Sweep',active:true,param:'J_c_param',range:'ï¼ˆ8ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰',params:[{k:'å‚™è€ƒ',v:'Jc 8ãƒ‘ã‚¿ãƒ¼ãƒ³'}]},
    {tag:newTag('stp'),type:'Time Dependent',active:true,tlist:'range(0,(magnetization_time+relaxation_time)/100,magnetization_time+relaxation_time)',params:[]}
  );
  // Dy2
  model.study.steps.push(
    {tag:newTag('stp'),type:'Parametric Sweep',active:true,param:'Dy2',range:'ï¼ˆ9ãƒ‘ã‚¿ãƒ¼ãƒ³, å˜ä½=mmï¼‰',params:[{k:'å‚™è€ƒ',v:'Dy2 9ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆmmï¼‰'}]},
    {tag:newTag('stp'),type:'Time Dependent',active:true,tlist:'range(0,(magnetization_time+relaxation_time)/100,magnetization_time+relaxation_time)',params:[]}
  );
  // Bsï¼ˆã‚¿ã‚¤ãƒ ï¼‰
  model.study.steps.push(
    {tag:newTag('stp'),type:'Time Dependent',active:true,tlist:'range(0,Bs_time/50,Bs_time)',params:[{k:'å‚™è€ƒ',v:'Bs 5ãƒ‘ã‚¿ãƒ¼ãƒ³æƒ³å®šï¼ˆé–¢æ•°åˆ‡æ›¿ï¼‰'}]}
  );

  // Dataset / Plotï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰
  const d1 = {tag:newTag('dset'),name:'Solution 1',fromStudy:model.study.tag,note:''};
  model.results.datasets.push(d1);
  const pg1 = {tag:newTag('pg'),name:'3D Plot Group 1',datasetTag:d1.tag,plots:[
    {tag:newTag('plt'),type:'Surface',selection:[],expr:'mf.normB',unit:'T',note:''}
  ]};
  model.results.plotGroups.push(pg1);
  model.results.derived.push({tag:newTag('plt'),name:'Line Average 1',type:'Line Average',selection:[],expr:'mf.Bz',note:''});
}

// è‡ªå‹•ä¿å­˜ãƒ»å¾©å…ƒ
function autoSave(){
  try{
    const data = JSON.stringify({model, nextId});
    localStorage.setItem('comsol_model', data);
  }catch(e){
    console.warn('Auto-save failed:', e);
  }
}
function autoLoad(){
  try{
    const data = localStorage.getItem('comsol_model');
    if(data){
      const parsed = JSON.parse(data);
      Object.assign(model, parsed.model);
      Object.assign(nextId, parsed.nextId);
      showToast('å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
      return true;
    }
  }catch(e){
    console.warn('Auto-load failed:', e);
  }
  return false;
}

// JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/PDF
function exportJSON(){
  const data = JSON.stringify({model, nextId}, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `comsol_model_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
}
function importJSON(){ document.getElementById('import-modal').classList.add('show'); }
function closeModal(){ document.getElementById('import-modal').classList.remove('show'); }
function loadJSONFile(){
  const file = document.getElementById('file-input').files[0];
  if(!file){ alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const parsed = JSON.parse(e.target.result);
      Object.assign(model, parsed.model);
      Object.assign(nextId, parsed.nextId);
      closeModal();
      showContent(currentId || 'parameters');
      autoSave();
      showToast('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
    }catch(err){
      alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
    }
  };
  reader.readAsText(file);
}
function exportPDF(){
  showToast('PDFç”Ÿæˆä¸­...');
  setTimeout(()=>{ window.print(); showToast('å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãã¾ã—ãŸ'); }, 100);
}
function showToast(msg){
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'), 3000);
}

// åˆæœŸåŒ–
if(!autoLoad()){
  seed();
  autoSave();
}

let currentId = null;
function toggleCategory(el){
  const subs = el.nextElementSibling;
  const icon = el.querySelector('.toggle-icon');
  subs.classList.toggle('show'); icon.classList.toggle('expanded');
}
function showContent(id){
  currentId=id;
  document.querySelectorAll('.subcategory').forEach(e=>e.classList.remove('active'));
  event?.target?.classList?.add('active');
  const main = document.getElementById('main');
  if(id==='parameters') return renderParameters(main);
  if(id==='variables')  return renderVariables(main);
  if(id==='functions')  return renderFunctions(main);
  if(id==='geometry')   return renderGeometry(main);
  if(id==='materials')  return renderMaterials(main);
  if(id==='physics')    return renderPhysics(main);
  if(id==='mesh')       return renderMesh(main);
  if(id==='study')      return renderStudy(main);
  if(id==='solver')     return renderSolver(main);
  if(id==='results')    return renderResults(main);
  if(id==='derived')    return renderDerived(main);
}

// å…±é€šUI
function panel(title,tag){ return `
  <div class="panel"><div class="panel-hd">
    <div class="panel-title">${title}${tag?` <span class="badge">(${tag})</span>`:''}</div>
  </div><div class="panel-bd">`; }
function panelEnd(){ return `</div></div>`; }
function addBtn(label,onclick){ return `<button onclick="${onclick}">${label}</button>`; }
function activeToggleHTML(obj){
  const id='sw-'+Math.random().toString(36).slice(2);
  setTimeout(()=>{
    const el=document.getElementById(id);
    if(el){
      el.checked = !!obj.active;
      el.onchange = ()=>{ obj.active = el.checked; autoSave(); };
    }
  },0);
  return `<label class="small">Active</label> <label class="switch"><input id="${id}" type="checkbox"><span class="slider"></span></label>`;
}
function unitSplit(expr){
  const m = String(expr||'').match(/^(.*)\[(.+)\]\s*$/);
  return m? {v:m[1],u:m[2]} : {v:expr,u:''};
}

// Parameters
function renderParameters(main){
  let html = panel('Parametersï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰');
  html += tableSimple('parameters','param',
    [{key:'name',label:'Name'},{key:'expr',label:'Expression'},{key:'unit',label:'Unit'},{key:'desc',label:'Description'}],
    model.global.parameters,
    (row,k,v)=>{ if(k==='expr'){ const p=unitSplit(v); row.expr=p.v; if(!row.unit) row.unit=p.u; } row[k]=v; autoSave(); },
    ()=>{ model.global.parameters.push({tag:newTag('param'),name:'',expr:'',unit:'',desc:''}); autoSave(); },
    row=>row.imp
  );
  html += `<div class="small">ï¼Šï¼é‡è¦ãƒ»è¦çµ±ä¸€ <span class="imp-badge">ï¼Š</span> è¡Œã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ</div>`;
  html += panelEnd();
  main.innerHTML = html;
}

// Variables
function renderVariables(main){
  let html = panel('Variablesï¼ˆå¤‰æ•°ï¼‰');
  html += tableSimple('variables','var',
    [{key:'name',label:'Name'},{key:'expr',label:'Expression'},{key:'unit',label:'Unit'},{key:'note',label:'Note'}],
    model.global.variables,
    (r,k,v)=>{ if(k==='expr'){ const p=unitSplit(v); r.expr=p.v; if(!r.unit) r.unit=p.u; } r[k]=v; autoSave(); },
    ()=>{ model.global.variables.push({tag:newTag('var'),name:'',expr:'',unit:'',note:''}); autoSave(); },
    row=>row.imp
  );
  html += `<div class="small">ï¼Šï¼é‡è¦ãƒ»è¦çµ±ä¸€ <span class="imp-badge">ï¼Š</span> è¡Œã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ</div>`;
  html += panelEnd();
  main.innerHTML = html;
}

// Functionsï¼ˆAnalytic / Piecewiseï¼‰
function renderFunctions(main){
  let html = panel('Functionsï¼ˆé–¢æ•°ï¼‰');
  html += `<div class="table-actions" style="margin-bottom:8px">${addBtn('ï¼‹Analyticé–¢æ•°è¿½åŠ ',"addFunction('Analytic')")} ${addBtn('ï¼‹Piecewiseé–¢æ•°è¿½åŠ ',"addFunction('Piecewise')")}</div>`;
  model.global.functions.forEach((f,idx)=>{
    html += `<div class="panel" style="border:1px solid #eaeef6">
      <div class="panel-hd"><div class="panel-title">${f.fname||'Function'} <span class="badge">(${f.tag})</span></div></div>
      <div class="panel-bd">
        <div class="kv"><label>Name</label><input value="${f.fname||''}" oninput="model.global.functions[${idx}].fname=this.value;autoSave()"></div>
        <div class="kv"><label>Arguments</label><input value="${f.args||''}" oninput="model.global.functions[${idx}].args=this.value;autoSave()"></div>
        <div class="kv"><label>Type</label>
          <select onchange="model.global.functions[${idx}].type=this.value;showContent('functions');autoSave()">
            <option ${f.type==='Analytic'?'selected':''}>Analytic</option>
            <option ${f.type==='Piecewise'?'selected':''}>Piecewise</option>
          </select>
        </div>
        ${f.type==='Analytic'
          ? `<div class="kv"><label>Expression</label><input value="${f.expr||''}" oninput="model.global.functions[${idx}].expr=this.value;autoSave()"></div>`
          : renderPieceTable(idx, f)}
        <div class="kv"><label>Unit</label><input value="${f.unit||''}" oninput="model.global.functions[${idx}].unit=this.value;autoSave()"></div>
        <div class="small"><button class="row-del" onclick="model.global.functions.splice(${idx},1);showContent('functions');autoSave()">ğŸ—‘ é–¢æ•°å‰Šé™¤</button></div>
      </div></div>`;
  });
  html += panelEnd();
  main.innerHTML = html;
}
function renderPieceTable(fi, f){
  const rows = (f.pieces||[]).map((p,pi)=>`
    <tr>
      <td><input value="${p.x??''}" oninput="model.global.functions[${fi}].pieces[${pi}].x=this.value;autoSave()"></td>
      <td><input value="${p.y??''}" oninput="model.global.functions[${fi}].pieces[${pi}].y=this.value;autoSave()"></td>
      <td><button class="row-del" onclick="model.global.functions[${fi}].pieces.splice(${pi},1);showContent('functions');autoSave()">ğŸ—‘</button></td>
    </tr>
  `).join('') || `<tr><td colspan="3" class="small">è¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œï¼‹è¡Œè¿½åŠ ã€ã§è¿½åŠ ã€‚</td></tr>`;
  const add = `model.global.functions[${fi}].pieces = model.global.functions[${fi}].pieces||[]; model.global.functions[${fi}].pieces.push({x:'',y:''}); showContent('functions'); autoSave();`;
  return `
  <div class="section-title">Piecesï¼ˆt, f(t)ï¼‰</div>
  <div class="table-wrap">
    <div class="table-head"><div class="table-title">piecewise</div>
      <div class="table-actions"><button onclick="${add}">ï¼‹è¡Œè¿½åŠ </button></div></div>
    <table class="table"><thead><tr><th>t</th><th>f(t)</th><th></th></tr></thead><tbody>${rows}</tbody></table>
  </div>`;
}
function addFunction(type){
  if(type==='Analytic'){
    model.global.functions.push({tag:newTag('fn'),fname:'f_analytic',args:'x',expr:'sin(x)',unit:'',type:'Analytic'});
  }else{
    model.global.functions.push({tag:newTag('fn'),fname:'f_piece',args:'t',type:'Piecewise',unit:'',pieces:[]});
  }
  showContent('functions'); autoSave();
}

// å…±æœ‰ãƒ†ãƒ¼ãƒ–ãƒ«
function tableSimple(contentId, prefix, columns, rows, onChange, onAdd, isImp){
  const head = columns.map(c=>`<th>${c.label}</th>`).join('')+'<th>Tag</th><th></th>';
  const body = rows.map((row,i)=>{
    const tds = columns.map(c=>{
      const val=row[c.key]??'';
      return `<td><input type="text" value="${val}" oninput="(${onChange})(modelPath('${contentId}')[${i}],'${c.key}',this.value)"></td>`;
    }).join('');
    const trClass = isImp && isImp(row) ? ' class="imp-row"' : '';
    const impBadge = isImp && isImp(row) ? '<span class="imp-badge">ï¼Š è¦çµ±ä¸€</span>' : '';
    return `<tr${trClass}>${tds}<td class="small">${row.tag||''}${impBadge}</td>
      <td><button class="row-del" onclick="modelPath('${contentId}').splice(${i},1);showContent('${contentId}');autoSave()">ğŸ—‘</button></td></tr>`;
  }).join('') || `<tr><td colspan="${columns.length+2}" class="small">è¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œï¼‹è¡Œè¿½åŠ ã€ã§è¿½åŠ ã€‚</td></tr>`;
  const addCall = `(${onAdd})();showContent('${contentId}')`;
  return `
  <div class="table-wrap">
    <div class="table-head"><div class="table-title">${prefix.toUpperCase()}</div>
      <div class="table-actions"><button onclick="${addCall}">ï¼‹è¡Œè¿½åŠ </button></div></div>
    <table class="table"><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table>
  </div>`;
}
function modelPath(id){
  switch(id){
    case 'parameters': return model.global.parameters;
    case 'variables' : return model.global.variables;
    case 'functions' : return model.global.functions;
  }
  return [];
}

// Geometry
function renderGeometry(main){
  let html = panel('Geometryï¼ˆcomp1/geom1ï¼‰');
  html += `<div class="section-title">å½¢çŠ¶ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ¦‚è¦ï¼‰</div>`;
  // ãƒ‘ã‚¿ãƒ¼ãƒ³è¡¨
  const headers = ['é …ç›®','ãƒªãƒ³ã‚°æ•°','å‘¨æœŸ','ã‚«ãƒƒãƒˆ','è§£æãƒ‘ã‚¿ãƒ¼ãƒ³'];
  const rows = (model.comp1.geometry.patterns||[]).map((p,i)=>{
    const [r1,r2,r3,r4] = p.cols || ['','','',''];
    return `<tr>
      <td>${i+1}</td>
      <td><input value="${r1?.split('=')[1]||''}" oninput="updateGeomPattern(${i},0,this.value)"></td>
      <td><input value="${r2?.split('=')[1]||''}" oninput="updateGeomPattern(${i},1,this.value)"></td>
      <td><input value="${r3?.split('=')[1]||''}" oninput="updateGeomPattern(${i},2,this.value)"></td>
      <td><input value="${r4?.split('=')[1]||''}" oninput="updateGeomPattern(${i},3,this.value)"></td>
    </tr>`;
  }).join('');
  html += `
    <div class="table-wrap">
      <div class="table-head"><div class="table-title">patterns</div></div>
      <table class="table">
        <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <div class="section-title">å½¢çŠ¶ã”ã¨ã®å¤‰æ›´ç‚¹ãƒã‚§ãƒƒã‚¯</div>
    <div class="small" style="white-space:pre-line">${model.comp1.geometry.notes||''}</div>
    <div class="hr"></div>
    <div class="section-title">Featuresï¼ˆè©³ç´°ã¯å¿…è¦æ™‚ã«è¿½åŠ ï¼‰</div>
    <div class="small">åŸºæœ¬å½¢çŠ¶ã¯åŒä¸€ã®ãŸã‚çœç•¥ä¸­ã€‚å¿…è¦ã«å¿œã˜ã¦ã€Œï¼‹Block / +Cylinder / +Differenceã€ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>
  `;
  html += panelEnd();
  main.innerHTML = html;
}
function updateGeomPattern(i, col, val){
  const keys = ['ãƒªãƒ³ã‚°æ•°','å‘¨æœŸ','ã‚«ãƒƒãƒˆ','è§£æ'];
  const arr = model.comp1.geometry.patterns[i].cols||[];
  arr[col] = `${keys[col]}=${val}`;
  model.comp1.geometry.patterns[i].cols = arr;
  autoSave();
}

// Materials
function renderMaterials(main){
  let html = panel('Materialsï¼ˆcomp1/materialsï¼‰');
  model.comp1.materials.forEach((m,idx)=>{
    html += `<div class="panel">
      <div class="panel-hd"><div class="panel-title">${m.name} <span class="badge">(${m.tag})</span></div>
        <div style="margin-left:auto">${activeToggleHTML(m)}</div>
      </div>
      <div class="panel-bd">
        <div class="kv"><label>è¡¨ç¤ºå</label><input value="${m.name}" oninput="model.comp1.materials[${idx}].name=this.value;autoSave()"></div>
        <div class="kv"><label>Selectionï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³IDï¼‰</label><div>${chipsHTML(m.selection, v=>{m.selection=v;})}</div></div>
        <div class="kv"><label>ãƒãƒ¼ãƒˆ</label><input value="${m.note||''}" oninput="model.comp1.materials[${idx}].note=this.value;autoSave()"></div>
        <div class="section-title">ã‚«ã‚¹ã‚¿ãƒ ç‰©æ€§</div>
        ${tableGeneric(`mat-${idx}`, ['ç‰©æ€§å','å€¤/å¼','å˜ä½','å‚™è€ƒ'],
          (m.props||[]).map(p=>[p.prop,p.val,p.unit,p.note||'']),
          (r,c,val)=>{ const p=m.props[r]; if(!p) return; const keys=['prop','val','unit','note']; p[keys[c]]=val; autoSave(); },
          ()=>{ (m.props||=[]).push({prop:'',val:'',unit:'',note:''}); showContent('materials'); autoSave(); },
          r=>{ m.props.splice(r,1); showContent('materials'); autoSave(); })}
        <div class="small"><button class="row-del" onclick="model.comp1.materials.splice(${idx},1);showContent('materials');autoSave()">ğŸ—‘ ãƒ–ãƒ­ãƒƒã‚¯å‰Šé™¤</button></div>
      </div></div>`;
  });
  html += panelEnd();
  main.innerHTML=html;
}

// Physics
function renderPhysics(main){
  let html = panel('Physicsï¼ˆcomp1ï¼‰');
  model.comp1.physics.forEach((p,idx)=>{
    html += `<div class="panel">
      <div class="panel-hd"><div class="panel-title">${p.name} <span class="badge">(${p.tag})</span></div>
        <div style="margin-left:auto">${activeToggleHTML(p)}</div>
      </div>
      <div class="panel-bd">
        <div class="kv"><label>è¡¨ç¤ºå</label><input value="${p.name}" oninput="model.comp1.physics[${idx}].name=this.value;autoSave()"></div>
        <div class="kv"><label>Selectionï¼ˆé ˜åŸŸ/å¢ƒç•ŒIDï¼‰</label><div>${chipsHTML(p.selection, v=>{p.selection=v;})}</div></div>
        <div class="kv"><label>ãƒãƒ¼ãƒˆ</label><input value="${p.note||''}" oninput="model.comp1.physics[${idx}].note=this.value;autoSave()"></div>
        <div class="section-title">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</div>
        ${tableGeneric(`phys-${idx}`, ['é …ç›®','å€¤/å¼','å˜ä½','å‚™è€ƒ'],
          (p.params||[]).map(q=>[q.k,q.v,q.u||'',q.note||'']),
          (r,c,val)=>{ const q=p.params[r]; const keys=['k','v','u','note']; q[keys[c]]=val; autoSave(); },
          ()=>{ (p.params||[]).push({k:'',v:'',u:'',note:''}); showContent('physics'); autoSave(); },
          r=>{ p.params.splice(r,1); showContent('physics'); autoSave(); })}
        <div class="small"><button class="row-del" onclick="model.comp1.physics.splice(${idx},1);showContent('physics');autoSave()">ğŸ—‘ ãƒ–ãƒ­ãƒƒã‚¯å‰Šé™¤</button></div>
      </div></div>`;
  });
  html += panelEnd();
  main.innerHTML=html;
}

// Mesh
function renderMesh(main){
  let html = panel('Meshï¼ˆcomp1/mesh1ï¼‰');
  model.comp1.mesh.features.forEach((f,idx)=>{
    html += `<div class="panel">
      <div class="panel-hd"><div class="panel-title">${f.name} <span class="badge">(${f.tag})</span></div>
        <div style="margin-left:auto">${activeToggleHTML(f)}</div>
      </div>
      <div class="panel-bd">
        <div class="kv"><label>Type</label><input value="${f.type}" oninput="model.comp1.mesh.features[${idx}].type=this.value;autoSave()"></div>
        <div class="kv"><label>Selectionï¼ˆIDï¼‰</label><div>${chipsHTML(f.selection, v=>{f.selection=v;})}</div></div>
        <div class="section-title">Parameters</div>
        ${tableGeneric(`mesh-${idx}`, ['é …ç›®','å€¤/å¼','å‚™è€ƒ'],
          (f.params||[]).map(q=>[q.k,q.v,q.note||'']),
          (r,c,val)=>{ const q=f.params[r]; const keys=['k','v','note']; q[keys[c]]=val; autoSave(); },
          ()=>{ (f.params||[]).push({k:'',v:'',note:''}); showContent('mesh'); autoSave(); },
          r=>{ f.params.splice(r,1); showContent('mesh'); autoSave(); })}
        <div class="small"><button class="row-del" onclick="model.comp1.mesh.features.splice(${idx},1);showContent('mesh');autoSave()">ğŸ—‘ ãƒ–ãƒ­ãƒƒã‚¯å‰Šé™¤</button></div>
      </div></div>`;
  });
  html += panelEnd();
  main.innerHTML=html;
}

// Study
function renderStudy(main){
  let html = panel('Study 1ï¼ˆstd1ï¼‰', model.study.tag);
  html += `<div class="section-title">Steps</div>`;
  model.study.steps.forEach((s,idx)=>{
    html += `<div class="panel">
      <div class="panel-hd"><div class="panel-title">Step ${idx+1}: ${s.type} <span class="badge">(${s.tag})</span></div>
        <div style="margin-left:auto">${activeToggleHTML(s)}</div>
      </div>
      <div class="panel-bd">
        ${s.type==='Time Dependent'?`
          <div class="kv"><label>æ™‚é–“è¨­å®šï¼ˆtlistï¼‰</label><input value="${(s.tlist||'')}" oninput="model.study.steps[${idx}].tlist=this.value;autoSave()" placeholder="t0:dt:t1 / range()"/></div>`:''}
        ${s.type==='Parametric Sweep'?`
          <div class="kv"><label>Parameter</label><input value="${(s.param||'')}" oninput="model.study.steps[${idx}].param=this.value;autoSave()"></div>
          <div class="kv"><label>Range/List</label><input value="${(s.range||'')}" oninput="model.study.steps[${idx}].range=this.value;autoSave()" placeholder="range(...)/list"/></div>`:''}
        <div class="section-title">ãã®ä»–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿/å‚™è€ƒ</div>
        ${tableGeneric(`step-${idx}`, ['é …ç›®','å€¤','å‚™è€ƒ'],
          (s.params||[]).map(q=>[q.k,q.v,q.note||'']),
          (r,c,val)=>{ const q=s.params[r]; const keys=['k','v','note']; q[keys[c]]=val; autoSave(); },
          ()=>{ (s.params||[]).push({k:'',v:'',note:''}); showContent('study'); autoSave(); },
          r=>{ s.params.splice(r,1); showContent('study'); autoSave(); })}
        <div class="small"><button class="row-del" onclick="model.study.steps.splice(${idx},1);showContent('study');autoSave()">ğŸ—‘ Stepå‰Šé™¤</button></div>
      </div></div>`;
  });
  html += panelEnd();
  main.innerHTML=html;
}

// Solver
function renderSolver(main){
  let html = panel('Solver / Convergence');
  html += tableGeneric('solver', ['ã‚¿ã‚¤ãƒ—','ç·šå½¢ã‚½ãƒ«ãƒãƒ¼','éç·šå½¢','å‰å‡¦ç†','RelTol','AbsTol','MaxIt','å‚™è€ƒ'],
    model.study.solver.map(s=>[s.type,s.lin,s.nonlin,s.precond,s.rel,s.abs,s.maxit,s.notes||'']),
    (r,c,v)=>{ const keys=['type','lin','nonlin','precond','rel','abs','maxit','notes']; model.study.solver[r][keys[c]]=v; autoSave(); },
    ()=>{ model.study.solver.push({type:'',lin:'',nonlin:'',precond:'',rel:'',abs:'',maxit:'',notes:''}); showContent('solver'); autoSave(); },
    r=>{ model.study.solver.splice(r,1); showContent('solver'); autoSave(); }
  );
  html += panelEnd();
  main.innerHTML=html;
}

// Results
function renderResults(main){
  let html = panel('Resultsï¼šDatasets / Plot Groups');
  // Datasets
  html += `<div class="section-title">Datasets</div>
    <div class="table-actions" style="margin-bottom:8px">${addBtn('ï¼‹Datasetè¿½åŠ ',"addDataset()")}</div>`;
  model.results.datasets.forEach((d,idx)=>{
    html += `<div class="panel">
      <div class="panel-hd"><div class="panel-title">${d.name} <span class="badge">(${d.tag})</span></div></div>
      <div class="panel-bd">
        <div class="kv"><label>Name</label><input value="${d.name}" oninput="model.results.datasets[${idx}].name=this.value;autoSave()"></div>
        <div class="kv"><label>From Study</label><input value="${d.fromStudy||model.study.tag}" oninput="model.results.datasets[${idx}].fromStudy=this.value;autoSave()"></div>
        <div class="kv"><label>Note</label><input value="${d.note||''}" oninput="model.results.datasets[${idx}].note=this.value;autoSave()"></div>
        <div class="small"><button class="row-del" onclick="model.results.datasets.splice(${idx},1);showContent('results');autoSave()">ğŸ—‘ Datasetå‰Šé™¤</button></div>
      </div></div>`;
  });
  // Plot Groups
  html += `<div class="section-title">Plot Groups</div>
    <div class="table-actions" style="margin-bottom:8px">${addBtn('ï¼‹Plot Groupè¿½åŠ ',"addPlotGroup()")}</div>`;
  model.results.plotGroups.forEach((pg,idx)=>{
    html += `<div class="panel">
      <div class="panel-hd"><div class="panel-title">${pg.name} <span class="badge">(${pg.tag})</span></div></div>
      <div class="panel-bd">
        <div class="kv"><label>Name</label><input value="${pg.name}" oninput="model.results.plotGroups[${idx}].name=this.value;autoSave()"></div>
        <div class="kv"><label>Dataset</label>
          <select onchange="model.results.plotGroups[${idx}].datasetTag=this.value;autoSave()">
            ${model.results.datasets.map(d=>`<option value="${d.tag}" ${pg.datasetTag===d.tag?'selected':''}>${d.name} (${d.tag})</option>`).join('')}
          </select>
        </div>
        <div class="section-title">Plots</div>
        <div class="table-actions" style="margin-bottom:8px">${addBtn('ï¼‹Plotè¿½åŠ ',`addPlot(${idx})`)}</div>
        ${(pg.plots||[]).map((pl,pi)=>`
          <div class="panel" style="border:1px dashed #e4e9f2">
            <div class="panel-hd"><div class="panel-title">${pl.type} <span class="badge">(${pl.tag})</span></div></div>
            <div class="panel-bd">
              <div class="kv"><label>Type</label><input value="${pl.type}" oninput="model.results.plotGroups[${idx}].plots[${pi}].type=this.value;autoSave()" placeholder="Surface/Line/Arrowç­‰"></div>
              <div class="kv"><label>Selectionï¼ˆIDï¼‰</label><div>${chipsHTML(pl.selection, v=>{pl.selection=v;})}</div></div>
              <div class="kv"><label>Expression</label><input value="${pl.expr||''}" oninput="model.results.plotGroups[${idx}].plots[${pi}].expr=this.value;autoSave()"></div>
              <div class="kv"><label>Unit</label><input value="${pl.unit||''}" oninput="model.results.plotGroups[${idx}].plots[${pi}].unit=this.value;autoSave()"></div>
              <div class="kv"><label>Note</label><input value="${pl.note||''}" oninput="model.results.plotGroups[${idx}].plots[${pi}].note=this.value;autoSave()"></div>
              <div class="small"><button class="row-del" onclick="model.results.plotGroups[${idx}].plots.splice(${pi},1);showContent('results');autoSave()">ğŸ—‘ Plotå‰Šé™¤</button></div>
            </div>
          </div>
        `).join('')}
        <div class="hr"></div>
        <div class="small"><button class="row-del" onclick="model.results.plotGroups.splice(${idx},1);showContent('results');autoSave()">ğŸ—‘ Plot Groupå‰Šé™¤</button></div>
      </div></div>`;
  });

  html += panelEnd();
  main.innerHTML=html;
}
function addDataset(){ model.results.datasets.push({tag:newTag('dset'),name:`Solution ${nextId.dset}`,fromStudy:model.study.tag,note:''}); showContent('results'); autoSave(); }
function addPlotGroup(){ const d = model.results.datasets[0]?.tag; model.results.plotGroups.push({tag:newTag('pg'),name:`3D Plot Group ${nextId.pg}`,datasetTag:d,plots:[]}); showContent('results'); autoSave(); }
function addPlot(pgIndex){ model.results.plotGroups[pgIndex].plots.push({tag:newTag('plt'),type:'Surface',selection:[],expr:'',unit:'',note:''}); showContent('results'); autoSave(); }

// Derived
function renderDerived(main){
  let html = panel('Derived Values');
  html += `<div class="table-actions" style="margin-bottom:8px">${addBtn('ï¼‹Derivedè¿½åŠ ',"addDerived()")}</div>`;
  model.results.derived.forEach((d,idx)=>{
    html += `<div class="panel">
      <div class="panel-hd"><div class="panel-title">${d.name} <span class="badge">(${d.tag})</span></div></div>
      <div class="panel-bd">
        <div class="kv"><label>Name</label><input value="${d.name}" oninput="model.results.derived[${idx}].name=this.value;autoSave()"></div>
        <div class="kv"><label>Type</label><input value="${d.type}" oninput="model.results.derived[${idx}].type=this.value;autoSave()" placeholder="Point/Line/Surface Average ç­‰"></div>
        <div class="kv"><label>Selectionï¼ˆIDï¼‰</label><div>${chipsHTML(d.selection, v=>{d.selection=v;})}</div></div>
        <div class="kv"><label>Expression</label><input value="${d.expr||''}" oninput="model.results.derived[${idx}].expr=this.value;autoSave()"></div>
        <div class="kv"><label>Note</label><input value="${d.note||''}" oninput="model.results.derived[${idx}].note=this.value;autoSave()"></div>
        <div class="small"><button class="row-del" onclick="model.results.derived.splice(${idx},1);showContent('derived');autoSave()">ğŸ—‘ Derivedå‰Šé™¤</button></div>
      </div></div>`;
  });
  html += panelEnd();
  main.innerHTML=html;
}
function addDerived(){ model.results.derived.push({tag:newTag('plt'),name:`Derived ${nextId.plt}`,type:'Line Average',selection:[],expr:'',note:''}); showContent('derived'); autoSave(); }

// ãƒ†ãƒ¼ãƒ–ãƒ«å…±é€š
function tableGeneric(id, headers, rows, onCell, onAdd, onDel){
  const head = headers.map(h=>`<th>${h}</th>`).join('') + '<th></th>';
  const body = rows.length? rows.map((r,ri)=>`
    <tr>
    ${r.map((v,ci)=>`<td><input type="text" value="${v??''}" oninput="(${onCell})(${ri},${ci},this.value)"></td>`).join('')}
    <td><button class="row-del" onclick="(${onDel})(${ri})">ğŸ—‘</button></td></tr>`).join('')
    : `<tr><td colspan="${headers.length+1}" class="small">è¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œï¼‹è¡Œè¿½åŠ ã€ã§è¿½åŠ ã€‚</td></tr>`;
  return `<div class="table-wrap">
    <div class="table-head"><div class="table-title">${id}</div>
      <div class="table-actions"><button onclick="(${onAdd})()">ï¼‹è¡Œè¿½åŠ </button></div></div>
    <table class="table"><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table></div>`;
}

updateStats();
</script>
</body>
</html>
